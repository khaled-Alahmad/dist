#!/bin/bash

# ==============================================
# School Management System - Update Script
# سكريبت التحديث لنظام إدارة المدرسة
# ==============================================

set -e  # إيقاف السكريبت عند أي خطأ

echo "================================================"
echo "🔄 بدء تحديث نظام إدارة المدرسة..."
echo "================================================"
echo ""

# الانتقال لمجلد المشروع
cd "$(dirname "$0")"
echo "📁 المجلد الحالي: $(pwd)"
echo ""

# 1. سحب أحدث نسخة من الكود
echo "📥 جاري سحب آخر التحديثات من Git..."
git pull origin main
echo "✅ تم سحب التحديثات بنجاح"
echo ""

# 2. تثبيت/تحديث الحزم
echo "📦 جاري تثبيت الحزم المطلوبة..."
npm install --production=false
echo "✅ تم تثبيت الحزم بنجاح"
echo ""

# 3. بناء المشروع
echo "🏗️ جاري بناء المشروع..."
npm run build
echo "✅ تم بناء المشروع بنجاح"
echo ""

# 4. تحديث قاعدة البيانات (إذا لزم الأمر)
echo "🗄️ جاري تحديث قاعدة البيانات..."
npm run db:push || echo "⚠️ تحذير: لم يتم تحديث قاعدة البيانات. قد لا تكون هناك تغييرات."
echo ""

# 5. إعادة تشغيل التطبيق
echo "🔄 جاري إعادة تشغيل التطبيق..."
pm2 restart school-management
echo "✅ تم إعادة تشغيل التطبيق بنجاح"
echo ""

# 6. التحقق من حالة التطبيق
echo "📊 حالة التطبيق:"
pm2 status school-management
echo ""

# 7. عرض آخر السجلات
echo "📝 آخر 20 سطر من السجلات:"
pm2 logs school-management --lines 20 --nostream
echo ""

echo "================================================"
echo "✅ اكتمل التحديث بنجاح!"
echo "================================================"
echo ""
echo "📌 ملاحظات:"
echo "  - للتحقق من السجلات: pm2 logs school-management"
echo "  - لمراقبة الأداء: pm2 monit"
echo "  - لإعادة التشغيل: pm2 restart school-management"
echo ""
echo "🌐 الموقع متاح على: https://yourdomain.com"
echo ""
