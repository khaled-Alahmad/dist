#!/bin/bash

# ==============================================
# School Management System - Update Script
# ุณูุฑูุจุช ุงูุชุญุฏูุซ ููุธุงู ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ
# ==============================================

set -e  # ุฅููุงู ุงูุณูุฑูุจุช ุนูุฏ ุฃู ุฎุทุฃ

echo "================================================"
echo "๐ ุจุฏุก ุชุญุฏูุซ ูุธุงู ุฅุฏุงุฑุฉ ุงููุฏุฑุณุฉ..."
echo "================================================"
echo ""

# ุงูุงูุชูุงู ููุฌูุฏ ุงููุดุฑูุน
cd "$(dirname "$0")"
echo "๐ ุงููุฌูุฏ ุงูุญุงูู: $(pwd)"
echo ""

# 1. ุณุญุจ ุฃุญุฏุซ ูุณุฎุฉ ูู ุงูููุฏ
echo "๐ฅ ุฌุงุฑู ุณุญุจ ุขุฎุฑ ุงูุชุญุฏูุซุงุช ูู Git..."
git pull origin main
echo "โ ุชู ุณุญุจ ุงูุชุญุฏูุซุงุช ุจูุฌุงุญ"
echo ""

# 2. ุชุซุจูุช/ุชุญุฏูุซ ุงูุญุฒู
echo "๐ฆ ุฌุงุฑู ุชุซุจูุช ุงูุญุฒู ุงููุทููุจุฉ..."
npm install --production=false
echo "โ ุชู ุชุซุจูุช ุงูุญุฒู ุจูุฌุงุญ"
echo ""

# 3. ุจูุงุก ุงููุดุฑูุน
echo "๐๏ธ ุฌุงุฑู ุจูุงุก ุงููุดุฑูุน..."
npm run build
echo "โ ุชู ุจูุงุก ุงููุดุฑูุน ุจูุฌุงุญ"
echo ""

# 4. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
echo "๐๏ธ ุฌุงุฑู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช..."
npm run db:push || echo "โ๏ธ ุชุญุฐูุฑ: ูู ูุชู ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช. ูุฏ ูุง ุชููู ููุงู ุชุบููุฑุงุช."
echo ""

# 5. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู
echo "๐ ุฌุงุฑู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู..."
pm2 restart school-management
echo "โ ุชู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุชุทุจูู ุจูุฌุงุญ"
echo ""

# 6. ุงูุชุญูู ูู ุญุงูุฉ ุงูุชุทุจูู
echo "๐ ุญุงูุฉ ุงูุชุทุจูู:"
pm2 status school-management
echo ""

# 7. ุนุฑุถ ุขุฎุฑ ุงูุณุฌูุงุช
echo "๐ ุขุฎุฑ 20 ุณุทุฑ ูู ุงูุณุฌูุงุช:"
pm2 logs school-management --lines 20 --nostream
echo ""

echo "================================================"
echo "โ ุงูุชูู ุงูุชุญุฏูุซ ุจูุฌุงุญ!"
echo "================================================"
echo ""
echo "๐ ููุงุญุธุงุช:"
echo "  - ููุชุญูู ูู ุงูุณุฌูุงุช: pm2 logs school-management"
echo "  - ููุฑุงูุจุฉ ุงูุฃุฏุงุก: pm2 monit"
echo "  - ูุฅุนุงุฏุฉ ุงูุชุดุบูู: pm2 restart school-management"
echo ""
echo "๐ ุงููููุน ูุชุงุญ ุนูู: https://yourdomain.com"
echo ""
